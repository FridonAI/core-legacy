<!DOCTYPE html>
<html>
<head>
    <title>Bitcoin Price Chart</title>
    <!-- Include Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>Bitcoin Price Chart</h1>
    <label for="interval">Select Interval:</label>
    <select id="interval">
        <option value="4h">4 Hours</option>
        <option value="1d" selected>1 Day</option>
    </select>
    <button id="generateBtn">Generate Chart</button>

    <div id="chartContainer" style="margin-top: 20px;">
        <!-- The chart will be rendered here -->
    </div>

    <script>
        document.getElementById('generateBtn').addEventListener('click', function() {
            var interval = document.getElementById('interval').value;

            fetch('/chart-data?interval=' + interval)
                .then(response => response.json())
                .then(data => {
                    if(data) {
                        renderChart(data, interval);
                    } else {
                        alert('Error generating chart.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error generating chart.');
                });
        });

        function renderChart(data, interval) {
            var dates = data.dates.map(date => new Date(date));

            // Candlestick trace
            var candlestick = {
                x: dates,
                open: data.open,
                high: data.high,
                low: data.low,
                close: data.close,
                type: 'candlestick',
                name: 'Price',
                xaxis: 'x',
                yaxis: 'y'
            };

            // EMA trace
            var ema = {
                x: dates,
                y: data.ema,
                type: 'scatter',
                mode: 'lines',
                name: 'EMA',
                line: { color: 'blue' },
                yaxis: 'y'
            };

            // VWAP trace
            var vwap = {
                x: dates,
                y: data.vwap,
                type: 'scatter',
                mode: 'lines',
                name: 'VWAP',
                line: { color: 'magenta' },
                yaxis: 'y'
            };

            // Volume trace
            var volume = {
                x: dates,
                y: data.volume,
                type: 'bar',
                name: 'Volume',
                marker: { color: 'grey' },
                xaxis: 'x',
                yaxis: 'y2',
                opacity: 0.5
            };

            // Support and Resistance lines
            var shapes = [];
            data.levels.forEach(level => {
                shapes.push({
                    type: 'line',
                    x0: dates[0],
                    x1: dates[dates.length - 1],
                    y0: level.Value,
                    y1: level.Value,
                    line: {
                        color: level.Type === 'Resistance' ? 'red' : 'green',
                        width: 1,
                        dash: 'dash'
                    }
                });
            });

            var layout = {
                title: `Bitcoin Price Chart (${interval.toUpperCase()})`,
                xaxis: {
                    rangeslider: { visible: false },
                    title: 'Date',
                    type: 'date'
                },
                yaxis: {
                    title: 'Price (USD)',
                    domain: [0.2, 1]
                },
                yaxis2: {
                    title: 'Volume',
                    domain: [0, 0.2],
                    anchor: 'x'
                },
                legend: { orientation: 'h', x: 0, y: 1.05 },
                shapes: shapes,
                height: 600
            };

            var data = [candlestick, ema, vwap, volume];

            Plotly.newPlot('chartContainer', data, layout);
        }
    </script>
</body>
</html>
